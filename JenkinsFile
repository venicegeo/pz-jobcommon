@Library('pipelib@master') _

def THREADFIX_ID = env.THREADFIX_ID ? env.THREADFIX_ID : '115'
node {
  def root = pwd()
  def mvn = tool 'M3'
  def appvers = sh(script: "git describe --long --tags --always | sed 's/\\./-/'g", returnStdout: true)

  stage('Setup') {
    deleteDir()
    git url: "git@gitlab.gs.mil:venice/pz-jobcommon", branch: "master", credentialsId: "aaef610c-9fd0-4812-9027-755ff3a872a5"
  }

  stage('Archive') {
    sh """
      ${mvn}/bin/mvn clean package -U -Dmaven.repo.local=${root}
      cp ${root}/target/pz-jobcommon-LATEST.jar ${root}/pz-jobcommon.jar
    """
    sh """mvn -X --settings ~/.m2/settings.xml deploy:deploy-file -Dfile=${root}/pz-jobcommon.jar \
      -DrepositoryId=nexus \
      -Durl="https://nexus.gs.mil/content/repositories/venice-release/" \
      -DgroupId="org.piazza" \
      -DgeneratePom=false \
      -Dpackaging=jar \
      -Dmaven.repo.local="${root}/.m2/repository" \
      -DartifactId=pz-jobcommon \
      -Dversion=${appvers}
    """
  }

  stage('Scans') {
    dependencyCheck {
      threadfixId = THREADFIX_ID
    }
    ionConnect()
    sh """
      mkdir -p ${root}/.m2/repository
      ${mvn}/bin/mvn clean org.jacoco:jacoco-maven-plugin:prepare-agent install \
        -Dmaven.repo.local=${root}/.m2/repository \
        -Pcoverage-per-test org.jacoco:jacoco-maven-plugin:report \
        -DdataFile=target/jacoco.exec
    """
    sonar()
    sh """
      ${mvn}/bin/mvn install:install-file -Dmaven.repo.local=${root} -Dfile=pom.xml -DpomFile=pom.xml
    """
    fortify {
      threadfixId = THREADFIX_ID
    }
  }

  stage('Cleanup') {
    deleteDir()
  }
}
